<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Chatbot</title>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html {
      span-family: sans-serif;
      line-height: 1.15;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
			span-size: 18px;
    }

    body {
      margin: 0;
      span-family: "Helvetica Neue",
	    Arial,
	    "Hiragino Kaku Gothic ProN",
	    "Hiragino Sans",
	    Meiryo,
	    sans-serif;
      span-size: 0.75rem;
      span-weight: 400;
      line-height: 1.5;
      color: #212529;
      text-align: left;
      background-color: #fff;
      margin: 50px;
    }

    h1 {
      text-align: center;
    }
  </style>
  <link rel="stylesheet" href="./chatbot/chatbot.css">
</head>

<body>

  <h1>Simple Chatbot</h1>

<p style="vertical-align:top;">
Q: <span class="q">兄弟で参加できますか？</span><span class="r" hidden>いいですか？</span><br />
A: <span class="a">参加資格があれば兄弟で参加が可能です。</span><br />
<br />
Q: <span class="q">申込締め切りはいつですか？今年の締切は？</span><span class="r" hidden>申し込みはできますか？</span><br />
A: <span class="a">申込締め切りは2月10日（木）を予定しています</span>。<br />
<br />
Q: <span class="q">対象年齢は？</span><span class="r" hidden>年齢制限はありますか？</span><br />
A: <span class="a">対象年齢は小学生〜高校生が対象です。（コースによって参加資格が異なります）</span><br />
<br />
Q: <span class="q">講座の内容は？</span><span class="r" hidden>どんな内容ですか？授業の内容は何をしますか？何が学べますか？何を勉強しますか？</span><br />
A: <span class="a">講座の内容は課題解決ワークショップ、プログラミング、マインクラフト、ホームページ作り、データ分析、AIプログラミングなどを企画中です。</span><br />
<br />
Q: <span class="q">オンラインのみですか？</span><span class="r" hidden>場所はどこですか？大学で開催しますか？遠隔授業ですか？</span><br />
A: <span class="a">オンラインと大学での対面を併用します。</span><br />
<br />
Q: <span class="q">プログラミング言語はなんですか？どんなことをしますか？</span><span class="r" hidden>どんなプログラミングをしますか？プログラム開発を学べますか？</span><br />
A: <span class="a">ビスケット、Scratch、マインクラフト(Make Code）、HTML、JavaScript、R言語、Python、等を予定しています。</span><br />
<br />
Q: <span class="q">小学生（小学1年生）でも参加できますか？</span><span class="r" hidden>何歳から参加できますか？未就学児でも大丈夫ですか？学年に制限はありますか？</span><br />
A: <span class="a">小学3年生以下の場合は保護者等の補助をお願いすることがあります。</span><br />
<br />
Q: <span class="q">抽選ですか？先着順ですか？</span><span class="r" hidden>定員はありますか？</span><br />
A: <span class="a">抽選の予定です。選に漏れた場合も、個別のイベントの案内はする予定です。</span><br />
<br />
Q: <span class="q">保護者にパソコンの知識がないが大丈夫ですか？</span><span class="r" hidden>子供だけで参加できますか？</span><br />
A: <span class="a">自宅でのオンライン受講の場合にパソコン操作が必要になりますが、困難な場合は会場での参加をご検討いただきます。</span><br />
<br />
Q: <span class="q">基礎知識がなくても大丈夫ですか？</span><span class="r" hidden>プログラミングしたことがありません。未経験でも大丈夫？</span><br />
A: <span class="a">基礎知識がなくても参加できるようコース設計に努めます。</span><br />
<br />
Q: <span class="q">参加費は無料ですか？</span><span class="r" hidden>タダですか？ただですか？いくらくらいかかりますか？費用はいくら？</span><br />
A: <span class="a">原則、参加費は無料とします。コースやイベントによっては材料費等をお支払いいただく可能性がございますので、事前にご連絡いたします。</span><br />
<br />
Q: <span class="q">土曜に参加できない場合は？</span><span class="r" hidden>何曜日ですか？土曜日？日曜日？平日？</span><br />
A: <span class="a">土曜以外に開催する場合やオンデマンドで参加してもらうことも予定しています。この場合、個別に作品や取り組み状況の提出をお願いすることがあります。</span><br />
<br />
Q: <span class="q">毎週開催ですか？いつ開催しますか？開催頻度は？</span><span class="r" hidden>いつ開催しますか？いつですか？授業はいつしますか？隔週ですか？</span><br />
A: <span class="a">月2回程度（隔週）を予定しています。</span><br />
<br />
Q: <span class="q">開催曜日と時間帯は決まっていますか？何時ごろ開催しますか？時間は？</span><span class="r" hidden>毎回何時ごろですか？午前ですか？午後ですか？</span><br />
A: <span class="a">原則、土曜日の午後の開催を予定しております。春休みや夏休み、祝祭日などに変則的に開催する可能性もあります。大体土曜日にやってます。</span><br />
<br />
Q: <span class="q">プログラミングについて初心者でも大丈夫ですか？</span><span class="r" hidden></span><br />
A: <span class="a">プログラミング初心者でも取り組めるようにコース設計に努めます。</span><br />
<br />
Q: <span class="q">すべてのコースを受講可能ですか？</span><span class="r" hidden></span><br />
A: <span class="a">学年や力量と受講状況に応じてコースを選択するため、受講できない場合があるかもしれませんのでご了承ください。</span><br />
<br />
Q: <span class="q">講座で利用できるパソコンがありません。</span><span class="r" hidden></span><br />
A: <span class="a">必要に応じて貸し出しを行います。<a class="icon-pdf" href="/fs/2/2/6/1/0/0/_/_____.pdf">機材借用書.pdf (PDF 92KB)</a>をよくお読みの上、<a href="https://forms.office.com/r/hEG37QZWDT">機材貸出の申し込みフォーム</a>からお申し込みください。</span></p>



  <!-- chatbot-btn -->
  <div class="chatbot-btn">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 20 20" width="20" height="20">
      <path fill="currentColor"
        d="M14 8.999v-5a2.003 2.003 0 00-2-2H3a2.003 2.003 0 00-2 2v5a2.003 2.003 0 002 2v1.694a.302.302 0 00.486.244l2.587-1.945H12A1.997 1.997 0 0014 9zm3-2h-2v2a3.003 3.003 0 01-3 3H7v2a2.003 2.003 0 002 2h3.927l2.59 1.941c.198.15.483.004.483-.243v-1.701h1a2.003 2.003 0 002-1.997v-5a2.003 2.003 0 00-2-2z" />
    </svg>
    <div class="chatbot-toggle-tooltip">ご質問はありますか？</div>
  </div>


  <!-- FingerPrint JS -->
  <script src="./chatbot/fp2.js"></script>
  <!-- ChatBot JS -->
  <script src="./chatbot/chatbot.js"></script>

  <script>
    // 1 - Specifying the key in localstorage where the browser fingerprint will be stored
    const keyLS = 'fingerprint';
    // 2 - Specifying the CSS selector for the button that will be used to call the dialog window with the chatbot
    const chatbotBtnSel = '.chatbot-btn';
    // 3 - URL to index.html
    const url = 'https://tokushimauniv.webhook.office.com/webhookb2/867d3b8b-a2f9-4b72-abfa-844f0e6ed5b1@8671c3a4-4538-47f6-8717-16a1d6b0ca98/IncomingWebhook/b4f60c8e8ac44f7f80c8814cb5ff0aa4/4f7c7e3f-d74d-41d6-b638-cce86cea6d72';
    // 4 - Data description that defines the dialog script for the chatbot
    const data = {
      bot: {
        0: {
          content: 'こんにちは！とくぽんAI塾です。何かご質問はありますか？', human: [0, 1, 2]
        },
        1: { content: 'そうなんですね。あなたのお名前は？', human: [3] },
        2: { content: 'あなたのお名前は？', human: [3] },
        3: { content: '{{name}}さん, 興味のあることは何ですか？', human: [4, 5] },
        4: { content: '{{name}}さん, こちらにアクセスしてください。 <a href="https://www.tokushima-u.ac.jp/ai/tokupon/" target="_blank">とくぽんAI塾</a>. こちらに詳しい情報があります。', human: [6] },
        5: { content: "{{name}}さん, ご質問はなんですか？", human: [7] },
        6: { content: '{{name}}さん, 次のいずれかの方法で詳しく教えてください。', human: [8, 9, 12] },
        7: { content: '{{name}}さん, お電話番号を教えてください。', human: [10] },
        8: { content: '{{name}}さん, Eメールアドレスを教えてください。', human: [10] },
        9: { content: 'OK! {{name}}さん, 折り返し {{contact}} へご連絡差し上げますので、少々お待ちください。', human: [6] },
        10: { content: 'ありがとう！あなたのお名前は？', human: [11] },
        11: { content: '<b>{{name}}さんもかわいいよ！</b> <br>興味のあることは何ですか？', human: [4, 5] },
				12: { content: 'こちらに<a href="tel:088-656-7095">電話</a>でお問い合わせください。', human: [6] },
				13: { content: 'こちらに<a href="mailto:kygakujc＠tokushima-u.ac.jp">メール</a>でお問い合わせください。', human: [6] },
				14: { content: 'こちらから<a href="https://www.tokushima-u.ac.jp/ai/asks/" target="_blank">Webフォーム</a>でお問い合わせください。', human: [6] },
        99: { content: '回答はこちら <br><br><div class="box">{{answer}}</div> <br>他に何か質問はありますか？', human: [4, 5] },
      },
      human: {
        0: { content: '質問したいことがあります。', bot: 1 },
        1: { content: '特にないです。', bot: 2 },
        2: { content: 'とくぽんかわいいね！', bot: 10 },
        3: { content: '', bot: 3, name: 'name' },
        4: { content: 'とくぽんAI塾に興味があります。', bot: 4 },
        5: { content: 'とくぽんAI塾について聞きたいことがあります。', bot: 5 },
        6: { content: '初めにもどる', bot: 3 },
        7: { content: '', bot: 6, name: '' },
        8: { content: '電話', bot: 12 },
        9: { content: 'Eメール', bot: 13 },
        10: { content: '', bot: 9, name: 'contact' },
        11: { content: '', bot: 11, name: 'name' },
	      12: { content: 'Webフォーム', bot: 14 },
      }
    }
    // adding a fingerprint hash to localstorage
		/*
    let fingerprint = localStorage.getItem(keyLS);
    if (!fingerprint) {
      Fingerprint2.get(function (components) {
        fingerprint = Fingerprint2.x64hash128(components.map(function (pair) { return pair.value }).join(), 31)
        localStorage.setItem(keyLS, fingerprint)
      });
    }*/
    // Initializing ChatBot by calling the following function and passing the required parameters to it
    chatBotInit({
      chatbotBtnSel: chatbotBtnSel,
      data: data,
      url: url,
      keyLS: keyLS
    });

    setTimeout(function () {
      const chatbotToggleTooltip = document.querySelector('.chatbot-toggle-tooltip');
      chatbotToggleTooltip.classList.add('chatbot-toggle-tooltip_show');
      setTimeout(function () {
        chatbotToggleTooltip.classList.remove('chatbot-toggle-tooltip_show');
      }, 10000)
    }, 10000)

  </script>

	<input id="sentence" maxlength="100" oninput="inputted();" size="30" type="text" />
	<div id="output">&nbsp;</div>

  <script src="./chatbot/path.js"></script>
	<script src="./chatbot/kuromoji.js"></script><script>
	let timer = null;

	const contentword = ['名詞', '動詞', '助動詞', '記号'];//, '形容詞'];
	const basicword = ['名詞', '動詞', '形容詞'];
	const builder = kuromoji.builder({ dicPath: RELATIVE_PATH })

	const analyzeKeyword = function(query_) {
		if (!query_ || query_ === '') {
			return [];
		}
		let keywords = [];
    let path = tokenizer_.tokenize(query_);
		let prev = '';
		for (const element of path) {
			if (!contentword.includes(element.pos)) {
				prev = '';
				continue;
			}
	  	keywords.push(element.surface_form.toLowerCase());
			if (prev.length > 0) {
					prev += element.surface_form;
		  	keywords.push(prev.toLowerCase());
			} else {
					prev += element.surface_form;
			}
			if (element.word_type !== "UNKNOWN" && basicword.includes(element.pos)) {
				keywords.push(element.basic_form.toLowerCase());
				keywords.push(element.pronunciation);
			}
		}
		return keywords;
	};

	const buildFunction = (string) => {
	  return (err, tokenizer) => {
			tokenizer_ = tokenizer;
	    //console.log('string',string);
	    //let path = tokenizer.tokenize(string);
	    //console.log('path',path);
	    //const target = document.getElementById("output");
			//output = '';
			//for (const element of path) {
			//  output += element.surface_form + ' ' + element.pos + '<br>';
			//}
	    //target.innerHTML = output;
			//humanContent = output;

			dataset = datasetInit({
				query: 'q',
				answer: 'a',
				refer: 'r',
			});
			for (let i = 0; i < dataset.q.length; i++) {
				query_ = i < dataset.q.length ? dataset.q[i] : '';
				let keys = analyzeKeyword(query_);
				answer_ = i < dataset.a.length ? dataset.a[i] : '';
				let anss = analyzeKeyword(answer_);
				refer_ = i < dataset.r.length ? dataset.r[i] : '';
				let refs = analyzeKeyword(refer_);
				dataset_.push({
						key: keys.concat(refs),
						ans: anss,
						a: dataset.a[i]
					});
			}
			//	alert(dataset_);
	  }
	};

	let dataset_ = [];
	let tokenizer_ = undefined;
	if (!tokenizer_) {
		builder.build(buildFunction(''));
	}

	const analyze = function() {
		const target = document.getElementById("sentence");
		if (target) {
			val = target.value;
		}
		if (typeof val === 'string' && val.length > 0) {
//		let result = builder.build(buildFunction(target.value));
			if (tokenizer_) {
		    let path = tokenizer_.tokenize(target.value);
		    //console.log('path',path);
		    const outtarget = document.getElementById("output");
				output = '';
				for (const element of path) {
				  output += element.surface_form + ' ' + element.pos + '<br>';
				}
		    outtarget.innerHTML = output;
			}
		}
	};
	const inputted = function() {
		if (timer != null) {
			clearTimeout(timer);
			timer = null;
		}
		timer = setTimeout(analyze, 1000);
	};
	const input = function(type, message) {
		if (typeof message === 'string' && message.length > 0) {
			if (tokenizer_) {
		    let path = tokenizer_.tokenize(message);
		    const outtarget = document.getElementById("output");
				let output = [];
				for (const element of path) {
				  //output += element.surface_form + ' ' + element.pos + '<br>';
					output.push([element.surface_form, element.pos]);
				}
				let content = '';
				let response = '';
				//builder.build(buildFunction(message));
				switch (type) {
					case 'name':
						// 敬称チェック
						switch (output[output.length-1][0]) {
							case 'くん':	case '君':	case 'さん':	case '様':
							case 'さま':	case 'ちゃん':	case '社長':	case '部長':
							case '課長':	case '係長':	case '委員長':	case '組長':
								output.pop();
							break;
						}
						for (const word of output) {
						  response += word[0] + ' ' + word[1] + '<br>';
							content += word[0];
						}
				    outtarget.innerHTML = response;
						return [content, ""];
					break;
					case 'contact':
						// 連絡先
				    outtarget.innerHTML = response;
						return [message, content];
					break;
					case '':
					{
						let queries = [];
						let prev = '';
						// 質問チェック
						for (const element of path) {
						  response += element.surface_form + ' ' + element.pos + '<br>';
							if (!contentword.includes(element.pos)) {
								prev = '';
								continue;
							}
							if (prev.length > 0) {
	 							prev += element.surface_form;
						  	queries.push(prev.toLowerCase());
							} else {
	 							prev += element.surface_form;
							}
					  	queries.push(element.surface_form.toLowerCase());
							if (element.word_type !== "UNKNOWN" && basicword.includes(element.pos)) {
								queries.push(element.basic_form.toLowerCase());
								queries.push(element.pronunciation);
							}
						}
				    outtarget.innerHTML = response;
						// 回答検索
						let maxans = [-1, 0];
						let answers = new Array(dataset_.length).fill(0);
						for (const word of queries) {
							for (let i = 0; i < dataset_.length; i++) {
								let key_ = dataset_[i].key;
								if (key_.includes(word)) {
									//content += dataset_[i].a;
									//alert(content);
									answers[i] += 1 / Math.sqrt(key_.length + 0.1);
								}
								let ans_ = dataset_[i].ans;
								if (ans_.includes(word)) {
									//content += dataset_[i].ans;
									//alert(content);
									answers[i] += 0.5 / Math.sqrt(ans_.length + 0.1);
								}
							}
						}
						let count = 0;
						for (let i = 0; i < answers.length; i++) {
							if (answers[i] > 0) {
								count++;
							}
							if (answers[i] > maxans[1]) {
								maxans[0] = i;
								maxans[1] = answers[i];
							}
						}
						if (maxans[1] > (count / answers.length) / queries.length) {
							content = dataset_[maxans[0]].a;
						}
						return [message, content];
					}
					break;
					default:
					return [message, ""];
					break;
				}
			}
		}
	}
	</script>
<table hidden="">
	<tbody>
		<tr>
			<td><a class="icon-gz" href="./chatbot/unk.dat.gz">unk.dat.gz (GZ 10.3KB)</a>
				<a class="icon-gz" href="./chatbot/unk_invoke.dat.gz">unk_invoke.dat.gz (GZ 1.11KB)</a>
				<a class="icon-gz" href="./chatbot/unk_compat.dat.gz">unk_compat.dat.gz (GZ 338バイト)</a>
				<a class="icon-gz" href="./chatbot/unk_pos.dat.gz">unk_pos.dat.gz (GZ 10.3KB)</a>
				<a class="icon-gz" href="./chatbot/unk_map.dat.gz">unk_map.dat.gz (GZ 1.16KB)</a>
				<a class="icon-gz" href="./chatbot/unk_char.dat.gz">unk_char.dat.gz (GZ 306バイト)</a>
				<a class="icon-gz" href="./chatbot/tid.dat.gz">tid.dat.gz (GZ 1.53MB)</a>
				<a class="icon-gz" href="./chatbot/tid_pos.dat.gz">tid_pos.dat.gz (GZ 5.64MB)</a>
				<a class="icon-gz" href="./chatbot/tid_map.dat.gz">tid_map.dat.gz (GZ 1.42MB)</a>
				<a class="icon-gz" href="./chatbot/check.dat.gz">check.dat.gz (GZ 2.97MB)</a>
				<a class="icon-gz" href="./chatbot/cc.dat.gz">cc.dat.gz (GZ 1.61MB)</a>
				<a class="icon-js" href="./chatbot/kuromoji.js">kuromoji.js (JS 301KB)</a></td>
		</tr>
	</tbody>
</table>

</body>

</html>
